 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Caleb Messiah Tech</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #90CAF9; 
            color: #0D47A1; 
            position: relative; 
            transition: filter 0.5s ease; 
        }
        .loader-active body { 
            filter: blur(5px); 
        }
        .admin-section { 
            padding: 40px 0; 
        }
        .card { 
            background-color: #E1F5FE; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }
        .card img { 
            width: 50px; 
            height: 50px; 
            object-fit: contain; 
        }
        .btn-primary { 
            background-color: #1976D2; 
            border: none; 
        }
        .btn-primary:hover { 
            background-color: #0D47A1; 
        }
        .btn-danger { 
            background-color: #D32F2F; 
        }
        .btn-danger:hover { 
            background-color: #B71C1C; 
        }
        .btn-warning { 
            background-color: #FBC02D; 
            color: #0D47A1; 
        }
        .btn-warning:hover { 
            background-color: #F9A825; 
        }
        .nav-tabs .nav-link { 
            color: #1976D2; 
        }
        .nav-tabs .nav-link.active { 
            background-color: #E1F5FE; 
            border-color: #1976D2; 
            color: #0D47A1; 
        }
        .loader { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            width: 100%; 
            background: rgba(255, 255, 255, 0.8); 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 9999; 
            transition: opacity 0.5s ease; 
        }
        .loader.hidden { 
            opacity: 0; 
            pointer-events: none; 
        }
        .spinner { 
            width: 50px; 
            height: 50px; 
            border: 5px solid #42A5F5; 
            border-top: 5px solid #9bfbcb; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .table { 
            background-color: #E1F5FE; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .table th, .table td { 
            vertical-align: middle; 
        }
        .repair-image { 
            max-width: 100px; 
            height: auto; 
            border-radius: 5px; 
        }
        @media (max-width: 768px) {
            .admin-section { 
                padding: 20px 0; 
            }
            .card { 
                font-size: 0.9rem; 
                padding: 15px; 
            }
            .table { 
                font-size: 0.9rem; 
            }
            .repair-image { 
                max-width: 80px; 
            }
        }
    </style>
</head>
<body>
    <div id="loader" class="loader">
        <div class="spinner"></div>
    </div>

    <section class="admin-section">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color: #1976D2;">Admin Dashboard</h2>
                <button class="btn btn-danger" id="logout">Logout</button>
            </div>
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link active" id="orders-tab" data-bs-toggle="tab" href="#orders">Orders</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="repairs-tab" data-bs-toggle="tab" href="#repairs">Repairs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="products-tab" data-bs-toggle="tab" href="#products">Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="users-tab" data-bs-toggle="tab" href="#users">Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="analytics-tab" data-bs-toggle="tab" href="#analytics">Analytics</a>
                </li>
            </ul>
            <div class="tab-content">
                <!-- Orders Tab -->
                <div class="tab-pane fade show active" id="orders">
                    <h4>Manage Orders</h4>
                    <div id="orderList"></div>
                </div>
                <!-- Repairs Tab -->
                <div class="tab-pane fade" id="repairs">
                    <h4>Manage Repairs</h4>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Repair ID</th>
                                <th>Customer</th>
                                <th>Device</th>
                                <th>Issue</th>
                                <th>Contact</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Image</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repairsTable"></tbody>
                    </table>
                </div>
                <!-- Products Tab -->
                <div class="tab-pane fade" id="products">
                    <h4>Manage Products</h4>
                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addProductModal">Add Product</button>
                    <div id="productList"></div>
                </div>
                <!-- Users Tab -->
                <div class="tab-pane fade" id="users">
                    <h4>Manage Users</h4>
                    <div id="userList"></div>
                </div>
                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics">
                    <h4>Sales Analytics</h4>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card p-3">
                                <h5>Total Sales</h5>
                                <p id="totalSales">₦0</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card p-3">
                                <h5>Total Orders</h5>
                                <p id="totalOrders">0</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card p-3">
                                <h5>Pending Orders</h5>
                                <p id="pendingOrders">0</p>
                            </div>
                        </div>
                    </div>
                    <h5>Top Selling Products</h5>
                    <ul id="topProducts" class="list-unstyled"></ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label for="productName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="productPrice" class="form-label">Price (₦)</label>
                            <input type="number" class="form-control" id="productPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="productStock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="productStock" required>
                        </div>
                        <div class="mb-3">
                            <label for="productImage" class="form-label">Image URL</label>
                            <input type="text" class="form-control" id="productImage">
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Add Product</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3">
                            <label for="editProductName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editProductName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductPrice" class="form-label">Price (₦)</label>
                            <input type="number" class="form-control" id="editProductPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductStock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="editProductStock" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductImage" class="form-label">Image URL</label>
                            <input type="text" class="form-control" id="editProductImage">
                        </div>
                        <div class="mb-3">
                            <label for="editProductDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editProductDescription" rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Update Product</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Loader
            $('body').addClass('loader-active');
            setTimeout(() => {
                $('#loader').addClass('hidden');
                $('body').removeClass('loader-active');
            }, 2000);

            // Authentication check
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login as an admin to access this page.');
                window.location.href = '/login.html';
                return;
            }

            // Fetch CSRF token
            let csrfToken;
            $.ajax({
                url: '/api/csrf-token',
                method: 'GET',
                async: false,
                success: function(response) {
                    csrfToken = response.csrfToken;
                },
                error: function(err) {
                    alert('Error fetching CSRF token: ' + (err.responseJSON?.message || 'Please try again.'));
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return;
                }
            });

            // Verify admin role
            $.ajax({
                url: '/api/auth/profile',
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function(user) {
                    if (user.role !== 'admin') {
                        alert('Access denied. Admin privileges required.');
                        localStorage.removeItem('token');
                        window.location.href = '/index.html';
                        return;
                    }
                },
                error: function(err) {
                    alert('Session expired or invalid token. Please login again.');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return;
                }
            });

            // Fetch orders
            function loadOrders() {
                $.ajax({
                    url: '/api/admin/orders',
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` },
                    success: function(orders) {
                        const orderList = $('#orderList');
                        orderList.empty();
                        if (orders.length === 0) {
                            orderList.append('<p class="text-center">No orders found.</p>');
                        } else {
                            orders.forEach(order => {
                                const orderHtml = `
                                    <div class="card" data-id="${order._id}">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h5>Order #${order.orderId}</h5>
                                                <span class="badge bg-${order.status === 'Delivered' ? 'success' : order.status === 'Shipped' ? 'info' : order.status === 'Processing' ? 'warning' : 'secondary'}">
                                                    ${order.status}
                                                </span>
                                            </div>
                                            <p>Customer: ${order.userId?.name || 'N/A'} (${order.userId?.email || 'N/A'})</p>
                                            <p>Date: ${new Date(order.createdAt).toLocaleDateString()}</p>
                                            <p>Total: ₦${order.total.toLocaleString()}</p>
                                            <button class="btn btn-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#orderDetails${order._id}">
                                                View Details
                                            </button>
                                            <select class="status-select ms-2" data-id="${order._id}">
                                                <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                                <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                                <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                                <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                            </select>
                                            <button class="btn btn-danger btn-sm ms-2 delete-order" data-id="${order._id}">Delete</button>
                                            <div class="collapse mt-3" id="orderDetails${order._id}">
                                                <h6>Items:</h6>
                                                <ul class="list-unstyled">
                                                    ${order.items.map(item => `
                                                        <li class="d-flex mb-2">
                                                            <img src="${item.image || '/images/default.png'}" alt="${item.name}">
                                                            <div class="ms-2">
                                                                <p class="mb-1">${item.name}</p>
                                                                <p class="mb-1">Qty: ${item.quantity}</p>
                                                                <p class="mb-1">₦${(item.price * item.quantity).toLocaleString()}</p>
                                                            </div>
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                                <h6>Shipping Address:</h6>
                                                <p>${order.shippingAddress}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                orderList.append(orderHtml);
                            });
                        }
                    },
                    error: function(err) {
                        $('#orderList').append('<p class="text-center">Error loading orders.</p>');
                    }
                });
            }

            // Fetch repairs
            function loadRepairs() {
                $.ajax({
                    url: '/api/admin/repairs',
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` },
                    success: function(repairs) {
                        const repairsTable = $('#repairsTable');
                        repairsTable.empty();
                        if (repairs.length === 0) {
                            repairsTable.append('<tr><td colspan="9" class="text-center">No repairs found.</td></tr>');
                        } else {
                            repairs.forEach(repair => {
                                repairsTable.append(`
                                    <tr data-id="${repair._id}">
                                        <td>${repair.repairId}</td>
                                        <td>${repair.name} (${repair.email})</td>
                                        <td>${repair.deviceType} (${repair.deviceModel})</td>
                                        <td>${repair.issue}</td>
                                        <td>${repair.contactMethod}</td>
                                        <td>${new Date(repair.preferredDate).toLocaleDateString()}</td>
                                        <td>
                                            <select class="status-select" data-id="${repair._id}">
                                                <option value="Pending" ${repair.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                                <option value="In Progress" ${repair.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                                <option value="Completed" ${repair.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                            </select>
                                        </td>
                                        <td>
                                            ${repair.image ? `<img src="${repair.image}" alt="Device Image" class="repair-image">` : 'No Image'}
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm delete-repair" data-id="${repair._id}">Delete</button>
                                        </td>
                                    </tr>
                                `);
                            });
                        }
                    },
                    error: function(err) {
                        $('#repairsTable').append('<tr><td colspan="9" class="text-center">Error loading repairs.</td></tr>');
                    }
                });
            }

            // Fetch products
            function loadProducts() {
                $.ajax({
                    url: '/api/products',
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` },
                    success: function(response) {
                        const productList = $('#productList');
                        productList.empty();
                        const products = response.products || [];
                        if (products.length === 0) {
                            productList.append('<p class="text-center">No products found.</p>');
                        } else {
                            products.forEach(product => {
                                const productHtml = `
                                    <div class="card" data-id="${product._id}">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <img src="${product.image || '/images/default.png'}" alt="${product.name}">
                                                <div class="ms-3">
                                                    <h5>${product.name}</h5>
                                                    <p>Price: ₦${product.price.toLocaleString()}</p>
                                                    <p>Stock: ${product.stock}</p>
                                                </div>
                                            </div>
                                            <button class="btn btn-warning btn-sm edit-product" data-id="${product._id}" 
                                                    data-name="${product.name}" data-price="${product.price}" 
                                                    data-stock="${product.stock}" data-image="${product.image || ''}" 
                                                    data-description="${product.description || ''}">Edit</button>
                                            <button class="btn btn-danger btn-sm ms-2 delete-product" data-id="${product._id}">Delete</button>
                                        </div>
                                    </div>
                                `;
                                productList.append(productHtml);
                            });
                        }
                    },
                    error: function(err) {
                        $('#productList').append('<p class="text-center">Error loading products.</p>');
                    }
                });
            }

            // Fetch users
            function loadUsers() {
                $.ajax({
                    url: '/api/admin/users',
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` },
                    success: function(users) {
                        const userList = $('#userList');
                        userList.empty();
                        if (users.length === 0) {
                            userList.append('<p class="text-center">No users found.</p>');
                        } else {
                            users.forEach(user => {
                                const userHtml = `
                                    <div class="card" data-id="${user._id}">
                                        <div class="card-body">
                                            <h5>${user.name}</h5>
                                            <p>Email: ${user.email}</p>
                                            <p>Role: ${user.role}</p>
                                            <p>Phone: ${user.phone || 'N/A'}</p>
                                            <button class="btn btn-danger btn-sm delete-user" data-id="${user._id}">Delete</button>
                                        </div>
                                    </div>
                                `;
                                userList.append(userHtml);
                            });
                        }
                    },
                    error: function(err) {
                        $('#userList').append('<p class="text-center">Error loading users.</p>');
                    }
                });
            }

            // Fetch analytics
            function loadAnalytics() {
                $.ajax({
                    url: '/api/admin/analytics',
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` },
                    success: function(data) {
                        $('#totalSales').text(`₦${data.totalRevenue.toLocaleString()}`);
                        $('#totalOrders').text(data.totalOrders);
                        $('#pendingOrders').text(data.totalOrders);
                    },
                    error: function(err) {
                        $('#totalSales').text('Error');
                        $('#totalOrders').text('Error');
                        $('#pendingOrders').text('Error');
                    }
                });
            }

            // Update order status
            $(document).on('change', '.status-select', function() {
                const id = $(this).data('id');
                const status = $(this).val();
                const isRepair = $(this).closest('table').is('#repairsTable');
                const url = isRepair ? `/api/admin/repairs/${id}` : `/api/admin/orders/${id}`;
                $.ajax({
                    url: url,
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    contentType: 'application/json',
                    data: JSON.stringify({ status, _csrf: csrfToken }),
                    success: function(response) {
                        alert(`${isRepair ? 'Repair' : 'Order'} status updated.`);
                        if (!isRepair) {
                            $(`[data-id="${id}"] .badge`).removeClass('bg-secondary bg-warning bg-info bg-success')
                                .addClass(`bg-${status === 'Delivered' ? 'success' : status === 'Shipped' ? 'info' : status === 'Processing' ? 'warning' : 'secondary'}`)
                                .text(status);
                            loadAnalytics();
                        }
                    },
                    error: function(err) {
                        alert('Error: ' + (err.responseJSON?.message || 'Please try again.'));
                    }
                });
            });

            // Delete order
            $(document).on('click', '.delete-order', function() {
                if (!confirm('Are you sure you want to delete this order?')) return;
                const orderId = $(this).data('id');
                $.ajax({
                    url: `/api/admin/orders/${orderId}`,
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                    contentType: 'application/json',
                    data: JSON.stringify({ _csrf: csrfToken }),
                    success: function(response) {
                        alert('Order deleted.');
                        $(`[data-id="${orderId}"]`).remove();
                        loadAnalytics();
                    },
                    error: function(err) {
                        alert('Error: ' + (err.responseJSON?.message || 'Please try again.'));
                    }
                });
            });

            // Delete repair
            $(document).on('click', '.delete-repair', function() {
                if (!confirm('Are you sure you want to delete this repair?')) return;
                const repairId = $(this).data('id');
                $.ajax({
                    url: `/api/admin/repairs/${repairId}`,
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                    contentType: 'application/json',
                    data: JSON.stringify({ _csrf: csrfToken }),
                    success: function(response) {
                        alert('Repair deleted.');
                        $(`[data-id="${repairId}"]`).remove();
                    },
                    error: function(err) {
                        alert('Error: ' + (err.responseJSON?.message || 'Please try again.'));
                    }
                });
            });

            // Add product
            $('#addProductForm').submit(function(e) {
                e.preventDefault();
                const productData = {
                    name: $('#productName').val(),
                    price: parseFloat($('#productPrice').val()),
                    stock: parseInt($('#productStock').val()),
                    image: $('#productImage').val(),
                    description: $('#productDescription').val(),
                    _csrf: csrfToken
                };
                $.ajax({
                    url: '/api/products',
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    contentType: 'application/json',
                    data: JSON.stringify(productData),
                    success: function(response) {
                        alert('Product added.');
                        $('#addProductModal').modal('hide');
                        $('#addProductForm')[0].reset();
                        loadProducts();
                    },
                    error: function(err) {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Please log in.');
            window.location.href = '/login.html';
            return;
        }

        // Loader
        $('#loader').removeClass('hidden');
        setTimeout(() => $('#loader').addClass('hidden'), 2000);

        // Fetch CSRF token
        $.ajax({
            url: '/api/csrf-token',
            method: 'GET',
            xhrFields: { withCredentials: true },
            success: function(response) {
                $('#csrfToken').val(response.csrfToken);
                console.log('CSRF token fetched:', response.csrfToken);
            },
            error: function(err) {
                console.error('CSRF token fetch error:', err);
                alert('Error fetching CSRF token');
            }
        });

        // Tab navigation
        $('.nav-link').click(function(e) {
            e.preventDefault();
            if ($(this).attr('id') === 'logout') {
                localStorage.removeItem('token');
                window.location.href = '/index.html';
                return;
            }
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.tab-content').addClass('d-none');
            $(`#${$(this).data('tab')}`).removeClass('d-none');
            window['load' + $(this).data('tab').charAt(0).toUpperCase() + $(this).data('tab').slice(1)]();
        });

        // Load Orders
        function loadOrders() {
            $.ajax({
                url: '/api/admin/orders',
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function(data) {
                    $('#orderList').empty();
                    if (!data.length) {
                        $('#orderList').append('<tr><td colspan="5">No orders found</td></tr>');
                        return;
                    }
                    data.forEach(order => {
                        $('#orderList').append(`
                            <tr>
                                <td>${order.orderId}</td>
                                <td>${order.userId?.name || 'Unknown'}</td>
                                <td>₦${order.total.toLocaleString()}</td>
                                <td>
                                    <select class="status-select order-status" data-id="${order._id}">
                                        <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                        <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                        <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                    </select>
                                </td>
                                <td><button class="btn btn-danger delete-order" data-id="${order._id}">Delete</button></td>
                            </tr>
                        `);
                    });
                },
                error: function(err) {
                    console.error('Load orders error:', err);
                    $('#orderList').html('<tr><td colspan="5">Error loading orders</td></tr>');
                    alert('Error: ' + (err.responseJSON?.message || 'Server error'));
                }
            });
        }

        // Load Repairs
        function loadRepairs() {
            $.ajax({
                url: '/api/admin/repairs',
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function(data) {
                    $('#repairsTable').empty();
                    if (!data.length) {
                        $('#repairsTable').append('<tr><td colspan="5">No repairs found</td></tr>');
                        return;
                    }
                    data.forEach(repair => {
                        $('#repairsTable').append(`
                            <tr>
                                <td>${repair.repairId}</td>
                                <td>${repair.userId?.name || 'Unknown'}</td>
                                <td>${repair.deviceType} (${repair.deviceModel})</td>
                                <td>
                                    <select class="status-select repair-status" data-id="${repair._id}">
                                        <option value="Pending" ${repair.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                        <option value="In Progress" ${repair.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="Completed" ${repair.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                </td>
                                <td><button class="btn btn-danger delete-repair" data-id="${repair._id}">Delete</button></td>
                            </tr>
                        `);
                    });
                },
                error: function(err) {
                    console.error('Load repairs error:', err);
                    $('#repairsTable').html('<tr><td colspan="5">Error loading repairs</td></tr>');
                    alert('Error: ' + (err.responseJSON?.message || 'Server error'));
                }
            });
        }

        // Load Products
        function loadProducts() {
            $.ajax({
                url: '/api/products',
                method: 'GET',
                success: function(data) {
                    $('#productList').empty();
                    if (!data.products.length) {
                        $('#productList').append('<p>No products found</p>');
                        return;
                    }
                    data.products.forEach(product => {
                        $('#productList').append(`
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5>${product.name}</h5>
                                    <p>${product.description}</p>
                                    <p>Price: ₦${product.price.toLocaleString()}</p>
                                    <p>Stock: ${product.stock}</p>
                                    <button class="btn btn-danger delete-product" data-id="${product._id}">Delete</button>
                                </div>
                            </div>
                        `);
                    });
                },
                error: function(err) {
                    console.error('Load products error:', err);
                    $('#productList').html('<p>Error loading products</p>');
                    alert('Error: ' + (err.responseJSON?.message || 'Server error'));
                }
            });
        }

        // Load Users
        function loadUsers() {
            $.ajax({
                url: '/api/admin/users',
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function(data) {
                    $('#userList').empty();
                    if (!data.length) {
                        $('#userList').append('<tr><td colspan="3">No users found</td></tr>');
                        return;
                    }
                    data.forEach(user => {
                        $('#userList').append(`
                            <tr>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td><button class="btn btn-danger delete-user" data-id="${user._id}">Delete</button></td>
                            </tr>
                        `);
                    });
                },
                error: function(err) {
                    console.error('Load users error:', err);
                    $('#userList').html('<tr><td colspan="3">Error loading users</td></tr>');
                    alert('Error: ' + (err.responseJSON?.message || 'Server error'));
                }
            });
        }

        // Load Analytics
        function loadAnalytics() {
            $.ajax({
                url: '/api/admin/analytics',
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function(data) {
                    $('#totalSales').text(`₦${data.totalRevenue.toLocaleString()}`);
                    $('#totalOrders').text(data.totalOrders);
                    $('#pendingOrders').text(data.totalOrders); // Adjust if needed
                },
                error: function(err) {
                    console.error('Load analytics error:', err);
                    alert('Error: ' + (err.responseJSON?.message || 'Server error'));
                }
            });
        }

        // Add Product
        $('#addProductForm').submit(function(e) {
            e.preventDefault();
            const productData = {
                name: $('#name').val(),
                description: $('#description').val(),
                price: Number($('#price').val()),
                brand: $('#brand').val(),
                stock: Number($('#stock').val()),
                image: $('#image').val(),
                _csrf: $('#csrfToken').val()
            };
            $.ajax({
                url: '/api/products',
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                contentType: 'application/json',
                data: JSON.stringify(productData),
                success: function(data) {
                    $('#addProductModal').modal('hide');
                    loadProducts();
                    alert('Product added successfully');
                },
                error: function(err) {
                    console.error('Add product error:', err);
                    alert('Error: ' + (err.responseJSON?.message || 'Server error'));
                }
            });
        });

        // Update Status
        $(document).on('change', '.status-select', function() {
            const id = $(this).data('id');
            const status = $(this).val();
            const isOrder = $(this).hasClass('order-status');
            const endpoint = isOrder ? 'orders' : 'repairs';
            console.log(`Updating ${endpoint} status:`, { id, status });
            $.ajax({
                url: `/api/admin/${endpoint}/${id}`,
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` },
                contentType: 'application/json',
                data: JSON.stringify({ status, _csrf: $('#csrfToken').val() }),
                success: function(data) {
                    console.log(`${endpoint} status updated:`, data);
                    alert('Status updated successfully');
                },
                error: function(err) {
                    console.error(`Update ${endpoint} status error:`, err);
                    alert('Error: ' + (err.responseJSON?.message || 'Server error'));
                }
            });
        });

        // Delete Actions
        $(document).on('click', '.delete-order, .delete-repair, .delete-product, .delete-user', function() {
            const id = $(this).data('id');
            const type = $(this).hasClass('delete-order') ? 'orders' :
                         $(this).hasClass('delete-repair') ? 'repairs' :
                         $(this).hasClass('delete-product') ? 'products' : 'users';
            if (confirm(`Delete this ${type.slice(0, -1)}?`)) {
                $.ajax({
                    url: `/api/admin/${type}/${id}`,
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                    data: { _csrf: $('#csrfToken').val() },
                    success: function() {
                        alert('Deleted successfully');
                        if (type === 'orders') loadOrders();
                        else if (type === 'repairs') loadRepairs();
                        else if (type === 'products') loadProducts();
                        else loadUsers();
                    },
                    error: function(err) {
                        console.error(`Delete ${type} error:`, err);
                        alert('Error: ' + (err.responseJSON?.message || 'Server error'));
                    }
                });
            }
        });

        // Initial load
        loadOrders();
    });
</script>
</body>
</html>
